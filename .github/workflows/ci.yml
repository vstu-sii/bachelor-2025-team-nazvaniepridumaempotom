name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Добавляем ручной запуск

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}
  MODEL_BRANCH: d2-ai
  APP_BRANCH: fullstack

jobs:
  # Тестирование Frontend из ветки fullstack
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout app code (fullstack branch)
      uses: actions/checkout@v4
      with:
        ref: ${{ env.APP_BRANCH }}
        path: app

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: app/frontend/package-lock.json

    - name: Install dependencies
      working-directory: ./app/frontend
      run: npm ci

    - name: Run linting
      working-directory: ./app/frontend
      run: |
        npm run lint
        npm run format:check

    - name: Run tests
      working-directory: ./app/frontend
      run: npm test -- --coverage --watchAll=false

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        directory: ./app/frontend/coverage
        flags: frontend
        name: frontend-coverage

  # Тестирование Backend из ветки fullstack
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.11']

    steps:
    - name: Checkout app code (fullstack branch)
      uses: actions/checkout@v4
      with:
        ref: ${{ env.APP_BRANCH }}
        path: app

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: app/backend/requirements.txt

    - name: Install dependencies
      working-directory: ./app/backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov black flake8 mypy

    - name: Run linting
      working-directory: ./app/backend
      run: |
        black --check .
        flake8 .
        mypy .

    - name: Run tests
      working-directory: ./app/backend
      run: |
        pytest --cov=app --cov-report=xml --cov-report=html tests/

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        directory: ./app/backend
        flags: backend
        name: backend-coverage

  # Тестирование LLM Service из ветки d2-ai
  test-llm-service:
    name: Test LLM Service
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout model code (d2-ai branch)
      uses: actions/checkout@v4
      with:
        ref: ${{ env.MODEL_BRANCH }}
        path: model

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: model/llm-service/requirements.txt

    - name: Install dependencies
      working-directory: ./model/llm-service
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest black flake8

    - name: Run linting
      working-directory: ./model/llm-service
      run: |
        black --check .
        flake8 .

    - name: Run tests
      working-directory: ./model/llm-service
      run: pytest tests/

    - name: Check model files exist
      working-directory: ./model/llm-service
      run: |
        # Проверяем наличие необходимых файлов модели
        if [ -f "models/model.pth" ]; then
          echo "Model file exists"
          ls -la models/
        else
          echo "Warning: Model file not found in expected location"
          echo "Looking for model files..."
          find . -name "*.pth" -o -name "*.pt" -o -name "*.bin" | head -10
        fi

  # Сборка Docker образов из обеих веток
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-frontend, test-backend, test-llm-service]
    
    steps:
    - name: Checkout app code (fullstack branch)
      uses: actions/checkout@v4
      with:
        ref: ${{ env.APP_BRANCH }}
        path: app

    - name: Checkout model code (d2-ai branch)
      uses: actions/checkout@v4
      with:
        ref: ${{ env.MODEL_BRANCH }}
        path: model

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Frontend (from fullstack)
      uses: docker/build-push-action@v5
      with:
        context: ./app/frontend
        file: ./app/frontend/Dockerfile.dev
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:app-${{ env.APP_BRANCH }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args:BRANCH_SOURCE: ${{ env.APP_BRANCH }}

    - name: Build and push Backend (from fullstack)
      uses: docker/build-push-action@v5
      with:
        context: ./app/backend
        file: ./app/backend/Dockerfile.dev
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:app-${{ env.APP_BRANCH }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args:BRANCH_SOURCE: ${{ env.APP_BRANCH }}

    - name: Build and push LLM Service (from d2-ai)
      uses: docker/build-push-action@v5
      with:
        context: ./model/llm-service
        file: ./model/llm-service/Dockerfile.dev
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llm-service:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llm-service:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llm-service:model-${{ env.MODEL_BRANCH }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args:BRANCH_SOURCE: ${{ env.MODEL_BRANCH }}

    - name: Generate docker-compose file
      run: |
        cat > docker-compose.ci.yml << EOF
        version: '3.8'
        
        services:
          frontend:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }}
            build:
              context: ./frontend
              dockerfile: Dockerfile.dev
            ports:
              - "3000:3000"
            environment:
              - REACT_APP_API_URL=http://backend:8000
              - BRANCH_SOURCE=${{ env.APP_BRANCH }}
        
          backend:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ github.sha }}
            build:
              context: ./backend
              dockerfile: Dockerfile.dev
            ports:
              - "8000:8000"
            environment:
              - LLM_SERVICE_URL=http://llm-service:5000
              - BRANCH_SOURCE=${{ env.APP_BRANCH }}
        
          llm-service:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llm-service:${{ github.sha }}
            build:
              context: ./llm-service
              dockerfile: Dockerfile.dev
            ports:
              - "5000:5000"
            environment:
              - MODEL_PATH=/app/models
              - BRANCH_SOURCE=${{ env.MODEL_BRANCH }}
            volumes:
              - ./llm-service/models:/app/models
        EOF
        
        echo "Generated docker-compose.ci.yml"
        cat docker-compose.ci.yml

  # Деплоймент (опционально)
  deploy:
    name: Deploy to Environment
    runs-on: ubuntu-latest
    needs: [build-docker]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: Download built images info
      run: |
        echo "Images built successfully:"
        echo "- Frontend: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }}"
        echo "- Backend: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ github.sha }}"
        echo "- LLM Service: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llm-service:${{ github.sha }}"
        echo ""
        echo "Source branches:"
        echo "- App components: ${{ env.APP_BRANCH }}"
        echo "- Model service: ${{ env.MODEL_BRANCH }}"
        
    - name: Create deployment summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Built Images" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend**: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend**: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **LLM Service**: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llm-service:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Source Branches" >> $GITHUB_STEP_SUMMARY
        echo "- **Application**: \`${{ env.APP_BRANCH }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Model**: \`${{ env.MODEL_BRANCH }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Pull Image Commands" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llm-service:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
