name: CI/CD Pipeline

on:
  push:
    branches: [ fullstack, d2-ai, MLOPS ]
  pull_request:
    branches: [ fullstack, d2-ai, MLOPS ]
  workflow_dispatch:  

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}
  MODEL_BRANCH: d2-ai          
  APP_BRANCH: fullstack        
  CONFIG_BRANCH: MLOPS

jobs:
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout app code (fullstack branch)
      uses: actions/checkout@v4
      with:
        ref: ${{ env.APP_BRANCH }}
        path: app

    - name: Checkout config files (infra branch)  # НОВЫЙ ШАГ
      uses: actions/checkout@v4
      with:
        ref: ${{ env.CONFIG_BRANCH }}
        path: config

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: config/frontend/package-lock.json  # ИЗМЕНЕНО: берем из config

    - name: Copy config files to app directory  # НОВЫЙ ШАГ
      run: |
        # Копируем package.json и package-lock.json из config в app
        cp config/frontend/package*.json app/frontend/ || true
        cp config/frontend/.eslintrc* app/frontend/ || true
        cp config/frontend/.prettierrc* app/frontend/ || true

    - name: Install dependencies
      working-directory: ./app/frontend  # ОСТАЕТСЯ: код из app
      run: npm ci
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.11']

    steps:
    - name: Checkout app code (fullstack branch)
      uses: actions/checkout@v4
      with:
        ref: ${{ env.APP_BRANCH }}
        path: app

    - name: Checkout config files (infra branch)  # НОВЫЙ ШАГ
      uses: actions/checkout@v4
      with:
        ref: ${{ env.CONFIG_BRANCH }}
        path: config

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: config/backend/requirements.txt  # ИЗМЕНЕНО: берем из config

    - name: Copy requirements file  # НОВЫЙ ШАГ
      run: |
        cp config/backend/requirements.txt app/backend/ || true
        cp config/backend/requirements-dev.txt app/backend/ || true

    - name: Install dependencies
      working-directory: ./app/backend  # ОСТАЕТСЯ: код из app
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov black flake8 mypy
  # Тестирование LLM Service из ветки d2-ai
  test-llm-service:
    name: Test LLM Service
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout model code (d2-ai branch)
      uses: actions/checkout@v4
      with:
        ref: ${{ env.MODEL_BRANCH }}
        path: model

    - name: Checkout config files (infra branch)  # НОВЫЙ ШАГ
      uses: actions/checkout@v4
      with:
        ref: ${{ env.CONFIG_BRANCH }}
        path: config

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: config/llm-service/requirements.txt  # ИЗМЕНЕНО: берем из config

    - name: Copy requirements file  # НОВЫЙ ШАГ
      run: |
        cp config/llm-service/requirements.txt model/llm-service/ || true

    - name: Install dependencies
      working-directory: ./model/llm-service  # ОСТАЕТСЯ: код из model
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest black flake8
  # Сборка Docker образов из обеих веток
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-frontend, test-backend, test-llm-service]
    
    steps:
    - name: Checkout app code (fullstack branch)
      uses: actions/checkout@v4
      with:
        ref: ${{ env.APP_BRANCH }}
        path: app

    - name: Checkout model code (d2-ai branch)
      uses: actions/checkout@v4
      with:
        ref: ${{ env.MODEL_BRANCH }}
        path: model

    - name: Checkout config files (infra branch)  # НОВЫЙ ШАГ
      uses: actions/checkout@v4
      with:
        ref: ${{ env.CONFIG_BRANCH }}
        path: config

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Frontend
      uses: docker/build-push-action@v5
      with:
        context: ./app/frontend  # КОД: из app
        file: ./config/frontend/Dockerfile.dev  # DOCKERFILE: из config
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:app-${{ env.APP_BRANCH }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BRANCH_SOURCE: ${{ env.APP_BRANCH }}
          CONFIG_SOURCE: ${{ env.CONFIG_BRANCH }}

    - name: Build and push Backend
      uses: docker/build-push-action@v5
      with:
        context: ./app/backend  # КОД: из app
        file: ./config/backend/Dockerfile.dev  # DOCKERFILE: из config
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:app-${{ env.APP_BRANCH }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args:
          BRANCH_SOURCE: ${{ env.APP_BRANCH }}
          CONFIG_SOURCE: ${{ env.CONFIG_BRANCH }}

    - name: Build and push LLM Service
      uses: docker/build-push-action@v5
      with:
        context: ./model/llm-service  # КОД: из model
        file: ./config/llm-service/Dockerfile.dev  # DOCKERFILE: из config
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llm-service:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llm-service:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llm-service:model-${{ env.MODEL_BRANCH }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BRANCH_SOURCE: ${{ env.MODEL_BRANCH }}
          CONFIG_SOURCE: ${{ env.CONFIG_BRANCH }}

    - name: Generate docker-compose file
      run: |
        cat > docker-compose.ci.yml << EOF
        version: '3.8'
        
        services:
          frontend:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }}
            ports:
              - "3000:3000"
            environment:
              - REACT_APP_API_URL=http://backend:8000
              - BRANCH_SOURCE=${{ env.APP_BRANCH }}
        
          backend:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ github.sha }}
            ports:
              - "8000:8000"
            environment:
              - LLM_SERVICE_URL=http://llm-service:5000
              - BRANCH_SOURCE=${{ env.APP_BRANCH }}
        
          llm-service:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llm-service:${{ github.sha }}
            ports:
              - "5000:5000"
            environment:
              - MODEL_PATH=/app/models
              - BRANCH_SOURCE=${{ env.MODEL_BRANCH }}
            volumes:
              - ./models:/app/models
        EOF
        
        echo "Generated docker-compose.ci.yml"
        cat docker-compose.ci.yml

  # Деплоймент (опционально)
  deploy:
    name: Deploy to Environment
    runs-on: ubuntu-latest
    needs: [build-docker]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: Download built images info
      run: |
        echo "Images built successfully:"
        echo "- Frontend: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }}"
        echo "- Backend: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ github.sha }}"
        echo "- LLM Service: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llm-service:${{ github.sha }}"
        echo ""
        echo "Source branches:"
        echo "- App components: ${{ env.APP_BRANCH }}"
        echo "- Model service: ${{ env.MODEL_BRANCH }}"
        
    - name: Create deployment summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Built Images" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend**: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend**: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **LLM Service**: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llm-service:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Source Branches" >> $GITHUB_STEP_SUMMARY
        echo "- **Application**: \`${{ env.APP_BRANCH }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Model**: \`${{ env.MODEL_BRANCH }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Pull Image Commands" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llm-service:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

